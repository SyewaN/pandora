#!/bin/bash
set -eu

source _common.sh
source /usr/share/yunohost/helpers

_pandora_set_paths

ynh_script_progression --message="Validating installation parameters..."

domain=$YNH_APP_ARG_DOMAIN
path_url=$YNH_APP_ARG_PATH
repo_url=$YNH_APP_ARG_REPO_URL
repo_branch=$YNH_APP_ARG_REPO_BRANCH
path_url=$(ynh_normalize_url_path --path_url="$path_url")

ynh_script_progression --message="Saving settings..."
ynh_app_setting_set --app="$app" --key=domain --value="$domain"
ynh_app_setting_set --app="$app" --key=path --value="$path_url"
ynh_app_setting_set --app="$app" --key=repo_url --value="$repo_url"
ynh_app_setting_set --app="$app" --key=repo_branch --value="$repo_branch"

ynh_script_progression --message="Installing system packages..."
ynh_install_app_dependencies "$pkg_dependencies"

ynh_script_progression --message="Allocating ports..."
backend_port=$(ynh_find_port --port=3000)
ai_port=$(ynh_find_port --port=5000)
ynh_app_setting_set --app="$app" --key=backend_port --value="$backend_port"
ynh_app_setting_set --app="$app" --key=ai_port --value="$ai_port"

ynh_script_progression --message="Preparing runtime directories..."
mkdir -p "$install_dir" "$data_dir" "$log_dir"
if ! id "$app" >/dev/null 2>&1; then
  useradd --system --home-dir "$install_dir" --shell /usr/sbin/nologin "$app"
fi

ynh_script_progression --message="Fetching application source..."
rm -rf "$install_dir"
git clone --depth 1 --branch "$repo_branch" "$repo_url" "$install_dir"

ynh_script_progression --message="Installing Node dependencies..."
npm install --prefix "$install_dir" --omit=dev
npm install --prefix "$install_dir" --omit=dev express cors helmet

ynh_script_progression --message="Installing Python dependencies..."
python3 -m venv "$install_dir/ai/venv"
"$install_dir/ai/venv/bin/pip" install --upgrade pip
"$install_dir/ai/venv/bin/pip" install flask flask-cors

ynh_script_progression --message="Creating data files..."
mkdir -p "$install_dir/data"
if [ ! -f "$data_dir/measurements.json" ]; then
  echo "[]" > "$data_dir/measurements.json"
fi
ln -sfn "$data_dir/measurements.json" "$install_dir/data/measurements.json"

_pandora_write_env "$backend_port" "$ai_port"
_pandora_install_systemd
_pandora_install_nginx "$domain" "$path_url" "$backend_port" "$ai_port"

chown -R "$app:$app" "$install_dir" "$data_dir" "$log_dir"

ynh_script_progression --message="Starting services..."
systemctl daemon-reload
systemctl enable --now "$backend_service" "$ai_service"
systemctl reload nginx

ynh_script_progression --message="Installation completed." --last
